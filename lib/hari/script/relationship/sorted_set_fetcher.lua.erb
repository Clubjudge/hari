function _h.sorted_set_fetch_relations_ids(start_node_id, relation, direction, from, stop, h)
  local key = 'hari:'..start_node_id..':'..relation..':'..direction

  if from == '' then
    return redis.call('zrevrange', key, from, stop)
  else
    return redis.call('zrevrangebyscore', key, '+inf', from, 'limit', 0, stop)
  end
end

function _h.sorted_set_fetch_nodes_ids(start_node_id, relation, direction, from, stop, h)
  local rels_ids = h.sorted_set_fetch_relations_ids(start_node_id, relation, direction, from, stop, h)

  local index = (direction == 'out' and 3 or 2)
  return h.map(rels_ids, function(r) return h.split(r, ':')[index] end)
end

function _h.sorted_set_count(start_node_id, relation, direction, h)
  local key = 'hari:'..start_node_id..':'..relation..':'..direction
  return redis.call('zcard', key)
end
